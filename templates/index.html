<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Progress Modeling - Interactive Dashboard</title>
    
    <!-- External Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    
    <style>
        /* Using external stylesheet at /static/styles.css */
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Header -->
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark mb-4">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1">AI Progress Model</span>
                        <div class="navbar-nav ms-auto">
                            <button class="btn btn-outline-light me-2" id="toggleThemeBtn" title="Toggle theme" onclick="toggleTheme()">
                                <i class="fas fa-moon"></i>
                            </button>
                            <button class="btn btn-outline-light me-2" onclick="loadDefaultData()">Reset to Default</button>
                            <button class="btn btn-outline-light me-2" onclick="exportResults()">Export CSV</button>
                            <button class="btn btn-outline-light" onclick="exportMETRData()">Export Progress-Adjusted METR Data</button>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
        
        <div class="row">
            <!-- Left Panel: Controls -->
            <div class="col-lg-4 left-panel">
                <div class="control-panel">
                    <!-- Summary Cards -->
                    <div class="row g-2 mb-3" id="summaryCards" style="display:none;">
                        <div class="col-6">
                            <div class="summary-card">
                                <div class="summary-label">SC Time</div>
                                <div class="summary-value" id="summary_sc_time">—</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="summary-card">
                                <div class="summary-label">SW Progress Multiplier at SC</div>
                                <div class="summary-value" id="summary_sc_rd_multiplier">—</div>
                            </div>
                        </div>
                    </div>
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs mb-3" id="controlTabs">
                        <li class="nav-item">
                            <button class="nav-link active" id="params-tab" data-bs-toggle="tab" data-bs-target="#params-panel">Parameters</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-panel">Data</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="estimation-tab" data-bs-toggle="tab" data-bs-target="#estimation-panel">Estimation</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <!-- Parameters Panel -->
                        <div class="tab-pane fade show active" id="params-panel">
                            <h5>Model Parameters</h5>

                            <div class="param-group">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">Time Horizon Parameters</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#timeHorizonParams" aria-expanded="false" aria-controls="timeHorizonParams">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="timeHorizonParams">
                                    <div class="mb-3">
                                        <label class="param-label">80% Time Horizon at Superhuman Coder: <span id="sc_time_horizon_minutes_val">Loading...</span> mins</label>
                                        <input type="range" class="range-input form-range" id="sc_time_horizon_minutes" step="0.1">
                                        <small class="text-muted">Time horizon length corresponding to superhuman coder achievement (1k-1M minutes)</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="param-label">Horizon Extrapolation Type:</label>
                                        <select class="form-select form-select-sm" id="horizon_extrapolation_type">
                                            <option value="exponential">Exponential</option>
                                            <option value="decaying doubling time">Decaying Doubling Time</option>
                                        </select>
                                        <small class="text-muted">Method for extrapolating progress beyond the time horizon</small>
                                    </div>
                                    
                                    <!-- Manual Horizon Fitting Parameters -->
                                    <div class="mb-3">
                                        <h6 class="text-muted mb-2">Manual Horizon Fitting</h6>
                                        <div class="mb-2">
                                            <label class="param-label">Anchor Time: <span id="anchor_time_val">Loading...</span></label>
                                            <input type="range" class="range-input form-range" id="anchor_time" step="0.01">
                                            <small class="text-muted">Reference time point for manual horizon fitting (2020-2030)</small>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="auto_fit_anchor_horizon">
                                                <label class="form-check-label" for="auto_fit_anchor_horizon">Auto-fit Anchor Horizon</label>
                                            </div>
                                            <label class="param-label">Anchor Horizon: <span id="anchor_horizon_val">Loading...</span> mins</label>
                                            <input type="range" class="range-input form-range" id="anchor_horizon" step="0.01" disabled>
                                            <small class="text-muted">Time horizon length at anchor time</small>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="auto_fit_anchor_doubling_time">
                                                <label class="form-check-label" for="auto_fit_anchor_doubling_time">Auto-fit Anchor Doubling Time</label>
                                            </div>
                                            <label class="param-label">Anchor Doubling Time: <span id="anchor_doubling_time_val">Loading...</span></label>
                                            <input type="range" class="range-input form-range" id="anchor_doubling_time" step="0.01" disabled>
                                            <small class="text-muted">Doubling time parameter at anchor point</small>
                                        </div>
                                        <div class="mb-2">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="auto_fit_doubling_decay_rate">
                                                <label class="form-check-label" for="auto_fit_doubling_decay_rate">Auto-fit Doubling Decay Rate</label>
                                            </div>
                                            <label class="param-label">Doubling Decay Rate: <span id="doubling_decay_rate_val">Loading...</span></label>
                                            <input type="range" class="range-input form-range" id="doubling_decay_rate" step="0.001" disabled>
                                            <small class="text-muted">Rate of decay for doubling time</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Coding Automation Anchors -->
                            <div class="param-group">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">Coding Automation Anchors</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#codingAutomationParams" aria-expanded="false" aria-controls="codingAutomationParams">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="codingAutomationParams">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="param-label">SC Automation Level: <span id="automation_fraction_at_superhuman_coder_val">Loading...</span></label>
                                            <input type="range" class="range-input form-range" id="automation_fraction_at_superhuman_coder" step="0.01">
                                            <small class="text-muted">Fraction of SWE tasks automated at the moment SC is achieved</small>
                                        </div>
                                        <div class="col-6">
                                            <label class="param-label">Automation Slope: <span id="automation_slope_val">Loading...</span></label>
                                            <input type="range" class="range-input form-range" id="automation_slope" step="0.1">
                                            <small class="text-muted">Steepness of automation transition</small>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="param-label">SWE Multiplier at Anchor Time: <span id="swe_multiplier_at_anchor_time_val">Loading...</span></label>
                                        <input type="range" class="range-input form-range" id="swe_multiplier_at_anchor_time" step="0.01">
                                        <small class="text-muted">Software engineering productivity multiplier at the anchor time</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Parallel Coding Labor Parameters -->
                            <div class="param-group">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">Parallel Coding Labor CES Parameters</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#cognitiveOutputParams" aria-expanded="false" aria-controls="cognitiveOutputParams">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="cognitiveOutputParams">
                                    <div class="mb-3">
                                        <label class="param-label">Task Substitutibility (ρ_cognitive): <span id="rho_cognitive_val">Loading...</span></label>
                                        <input type="range" class="range-input form-range" id="rho_cognitive" step="0.05">
                                        <small class="text-muted">Substitutability between automated and non-automated SWE tasks.</small>
                                        <small class="text-muted" id="rho_cognitive_range">Loading range...</small>
                                    </div>
                                                                    
                                    <div class="mb-3">
                                        <label class="param-label">Parallel Coding Labor Normalization: <span id="cognitive_output_normalization_val">Loading...</span></label>
                                        <input type="range" class="range-input form-range" id="cognitive_output_normalization" step="0.1">
                                        <small class="text-muted">Scale factor for parallel coding labor output (log scale: 10^value)</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="param-label">Lambda (λ): <span id="lambda_val">Loading...</span></label>
                                        <input type="range" class="range-input form-range" id="lambda" step="0.05">
                                        <small class="text-muted">Power transformation parameter applied to CES output before normalization</small>
                                    </div>
                                </div>
                            </div>
                            <div class="param-group">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">Experiment Capacity CES Parameters</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#experimentCapacityParams" aria-expanded="false" aria-controls="experimentCapacityParams">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="experimentCapacityParams">
                                    <div class="mb-3">
                                        <label class="param-label">Experiment Input Substitutibility (ρ_progress): <span id="rho_progress_val">Loading...</span></label>
                                        <input type="range" class="range-input form-range" id="rho_progress" step="0.05">
                                        <small class="text-muted">Substitutability between exp. compute and parallel coding labor.</small>
                                        <small class="text-muted" id="rho_progress_range">Loading range...</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="param-label">Experiment Compute Weight (α): <span id="alpha_val">Loading...</span></label>
                                        <input type="range" class="range-input form-range" id="alpha" step="0.05">
                                        <small class="text-muted">Higher values favor experiment compute over parallel coding labor</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="param-label">Experiment Compute Discounting (ζ): <span id="zeta_val">Loading...</span></label>
                                        <input type="range" class="range-input form-range" id="zeta" step="0.05">
                                        <small class="text-muted">Relates OOMs of experiment compute to OOMs of parallel coding labor.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Research Taste Anchors -->
                            <div class="param-group">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">AI Research Taste Anchors</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#aiResearchTasteParams" aria-expanded="false" aria-controls="aiResearchTasteParams">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="aiResearchTasteParams">
                                    <div class="mb-3">
                                        <label class="param-label">Schedule Type:</label>
                                        <select class="form-select form-select-sm" id="taste_schedule_type">
                                            <option value="exponential">Exponential</option>
                                            <option value="sigmoid">Sigmoid</option>
                                            <option value="sd_per_progress">SD per Progress</option>
                                        </select>
                                        <small class="text-muted">Type of curve for AI research taste evolution</small>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="param-label">SC Research Taste: <span id="ai_research_taste_at_superhuman_coder_val">Loading...</span></label>
                                            <input type="range" class="range-input form-range" id="ai_research_taste_at_superhuman_coder" step="0.01">
                                            <small class="text-muted">Research Taste at SC (units: multiplier on research effort)</small>
                                        </div>
                                        <div class="col-6">
                                            <label class="param-label">AI Research Taste Slope: <span id="ai_research_taste_slope_val">Loading...</span></label>
                                            <input type="range" class="range-input form-range" id="ai_research_taste_slope" step="0.1">
                                            <small class="text-muted">Steepness of research taste curve</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="param-group">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">Effective Compute Parameters</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#overallProgressParams" aria-expanded="false" aria-controls="overallProgressParams">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="overallProgressParams">
                                    <div class="mb-3">
                                        <label class="param-label">Returns to Software R&D: <span id="software_scale_val">Loading...</span></label>
                                        <input type="range" class="range-input form-range" id="software_scale" step="0.05">
                                        <small class="text-muted">Determines the number of doublings of software efficiency per doubling in cumulative research effort.</small>
                                        <small class="text-muted" id="software_scale_range">Loading range...</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Normalization Parameters -->
                            <!-- <div class="param-group">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">Normalization Constants</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#normalizationParams" aria-expanded="false" aria-controls="normalizationParams">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="normalizationParams">

                                </div>
                            </div> -->
                            
                            <!-- Simulation Settings -->
                            <div class="param-group">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="text-muted mb-0">Simulation Settings</h6>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#simulationSettingsParams" aria-expanded="false" aria-controls="simulationSettingsParams">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse" id="simulationSettingsParams">
                                    <div class="row">
                                        <div class="col-4">
                                            <label class="param-label">Start Year</label>
                                            <input type="number" class="form-control form-control-sm" id="start_year">
                                        </div>
                                        <div class="col-4">
                                            <label class="param-label">End Year</label>
                                            <input type="number" class="form-control form-control-sm" id="end_year">
                                        </div>
                                        <div class="col-4">
                                            <label class="param-label">Initial Progress</label>
                                            <input type="number" class="form-control form-control-sm" id="initial_progress" step="0.01">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-2">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoUpdate" checked>
                                        <label class="form-check-label" for="autoUpdate">Auto-update on slider change</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn btn-primary w-100" onclick="computeModel()">Update Model</button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-secondary w-100" onclick="resetToDefaults()">Reset</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Data Panel -->
                        <div class="tab-pane fade" id="data-panel">
                            <h5>Time Series Data</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Upload Custom CSV Data</label>
                                <input type="file" class="form-control" id="csvFile" accept=".csv" onchange="uploadData()">
                                <div class="form-text">CSV should have columns: time, L_HUMAN, L_AI, experiment_compute, training_compute</div>
                            </div>
                            
                            <div class="mb-3">
                                <button class="btn btn-secondary w-100" onclick="loadDefaultData()">Load Default Data</button>
                            </div>
                            
                            <div id="dataPreview" class="mt-3" style="display: none;">
                                <h6>Data Summary</h6>
                                <div id="dataSummary"></div>
                            </div>
                        </div>
                        
                        <!-- Parameter Estimation Panel -->
                        <div class="tab-pane fade" id="estimation-panel">
                            <h5>Parameter Estimation</h5>
                            <p class="text-muted">Define anchor constraints to estimate optimal parameters</p>
                            
                            <div id="anchorConstraints">
                                <!-- Dynamic constraints will be added here -->
                            </div>
                            
                            <button class="btn btn-sm btn-success mb-3" onclick="addAnchorConstraint()">
                                <i class="fas fa-plus"></i> Add Constraint
                            </button>
                            
                            <div class="param-group">
                                <h6 class="text-muted">Parameters to Optimize</h6>
                                <p><small>Uncheck a parameter to hold it fixed at its current value during optimization.</small></p>
                                <div id="fixedParamsCheckboxes">
                                    <!-- Checkboxes will be dynamically generated here -->
                                </div>
                            </div>
                            
                            <div id="constraintValidation" class="alert alert-info" style="display: none;">
                                <h6>Constraint Validation</h6>
                                <div id="validationResults"></div>
                            </div>
                            
                            <button class="btn btn-warning w-100 mt-3" onclick="estimateParameters()" disabled id="estimateBtn">
                                Estimate Parameters (Add constraints first)
                            </button>
                        </div>
                    </div>
                </div>

            </div>
            
            <!-- Right Panel: Visualization -->
            <div class="col-lg-8 right-panel">
                <!-- Plot Tab Navigation -->
                <ul class="nav nav-tabs mb-3" id="plotTabs" style="display: none;">
                    <!-- Tabs will be dynamically populated -->
                </ul>
                
                <div class="plot-container">
                    <!-- Tab content for plots -->
                    <div class="tab-content" id="plotTabContent">
                        <!-- Default single plot container for initial load -->
                        <div class="tab-pane fade show active" id="default-plot">
                            <div id="plotDiv" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                    
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Computing...</span>
                        </div>
                        <div class="mt-2">Computing model trajectory...</div>
                    </div>
                </div>
                
                <div class="alert alert-danger error-alert mt-3" id="errorAlert">
                    <strong>Error:</strong> <span id="errorMessage"></span>
                </div>
                <div class="app-footer text-center mt-3">
                    <span>Built with Plotly + Flask. Use the sliders to explore scenarios. Toggle light/dark with the moon/sun icon.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme handling
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const icon = document.querySelector('#toggleThemeBtn i');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            // Update Plotly background/foreground to match theme
            try {
                const isDark = theme === 'dark';
                const bg = isDark ? '#0f172a' : 'white';
                const fg = isDark ? '#e5e7eb' : '#2b2d42';
                const hoverBg = isDark ? '#111827' : 'white';
                const hoverBorder = isDark ? '#334155' : '#e0e0e0';
                // Update all visible plots
                if (window.plotIds && window.plotData) {
                    Object.keys(window.plotIds).forEach(key => {
                        if (key.endsWith('_created')) return;
                        const pid = window.plotIds[key];
                        if (!pid) return;
                        const plotEl = document.getElementById(pid);
                        if (!plotEl) return;
                        const layout = (window.plotData[key] && window.plotData[key].layout) ? { ...window.plotData[key].layout } : {};
                        layout.paper_bgcolor = bg;
                        layout.plot_bgcolor = bg;
                        layout.font = { ...(layout.font || {}), color: fg };
                        layout.title = { ...(layout.title || {}), font: { ...(layout.title?.font || {}), color: fg } };
                        layout.hoverlabel = { ...(layout.hoverlabel || {}), bgcolor: hoverBg, bordercolor: hoverBorder, font: { ...(layout.hoverlabel?.font || {}), color: fg } };
                        if (Array.isArray(layout.annotations)) {
                            layout.annotations = layout.annotations.map(a => ({
                                ...a,
                                font: { ...(a.font || {}), color: fg }
                            }));
                        }
                        Plotly.relayout(plotEl, layout);
                    });
                } else {
                    // Single plot mode fallback
                    const el = document.getElementById('plotDiv');
                    if (el) {
                        const ly = el.layout ? JSON.parse(JSON.stringify(el.layout)) : {};
                        ly.paper_bgcolor = bg;
                        ly.plot_bgcolor = bg;
                        ly.font = { ...(ly.font || {}), color: fg };
                        ly.title = { ...(ly.title || {}), font: { ...(ly.title?.font || {}), color: fg } };
                        ly.hoverlabel = { ...(ly.hoverlabel || {}), bgcolor: hoverBg, bordercolor: hoverBorder, font: { ...(ly.hoverlabel?.font || {}), color: fg } };
                        if (Array.isArray(ly.annotations)) {
                            ly.annotations = ly.annotations.map(a => ({
                                ...a,
                                font: { ...(a.font || {}), color: fg }
                            }));
                        }
                        Plotly.relayout(el, ly);
                    }
                }
            } catch (e) { console.warn('Failed to apply theme to Plotly', e); }
        }
        function toggleTheme() {
            const current = localStorage.getItem('theme') || 'light';
            setTheme(current === 'light' ? 'dark' : 'light');
        }
        (function initTheme(){
            const saved = localStorage.getItem('theme');
            if (saved) setTheme(saved);
        })();
        // Global parameter configuration from server
        let parameterConfig = null;
        
        // Load parameter configuration from server
        async function loadParameterConfig() {
            try {
                const response = await fetch('/api/parameter-config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    parameterConfig = data.config;
                    console.log('Successfully loaded parameter configuration:', parameterConfig);
                    
                    // Validate config structure
                    if (!parameterConfig.bounds || !parameterConfig.defaults) {
                        console.warn('Parameter config is missing expected properties:', parameterConfig);
                    }
                } else {
                    throw new Error(data.error || 'Unknown API error');
                }
            } catch (error) {
                console.error('Failed to load parameter configuration:', error.message);
                console.warn('Falling back to hardcoded parameter values');
                parameterConfig = null;
                
                // Show user-friendly warning if needed
                showConfigWarning('Parameter configuration could not be loaded from server. Using default values.');
            }
        }
        
        function showConfigWarning(message) {
            // Show a non-intrusive warning about config loading failure
            const warningDiv = document.createElement('div');
            warningDiv.className = 'alert alert-warning alert-dismissible fade show';
            warningDiv.style.position = 'fixed';
            warningDiv.style.top = '10px';
            warningDiv.style.right = '10px';
            warningDiv.style.zIndex = '9999';
            warningDiv.style.maxWidth = '400px';
            warningDiv.innerHTML = `
                <small><strong>Configuration Notice:</strong> ${message}</small>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(warningDiv);
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.remove();
                }
            }, 10000);
        }
        
        // Initialize app
        $(document).ready(function() {
            // Ensure plot container has consistent height from the start
            const plotContainer = $('.plot-container')[0];
            if (plotContainer) {
                plotContainer.style.setProperty('height', '1280px', 'important');
                // Force a reflow to ensure the height is applied immediately
                plotContainer.offsetHeight;
            }
            
            // Load parameter configuration first, then initialize everything
            loadParameterConfig().then(() => {
                // Initialize server session in parallel with UI setup
                const sessionPromise = initializeSession();
                
                // Set up UI controls from parameter config
                initializeParameterControls();
                initializeControls();
                populateFixedParamsCheckboxes();
                
                // Wait for session to be ready, then compute model
                sessionPromise.then(() => {
                    computeModel();
                }).catch(() => {
                    // If session init fails, still try to compute (fallback mode)
                    console.warn('Computing model without proper session initialization');
                    computeModel();
                });
            });
        });
        
        function initializeControls() {
            // Add event listeners to all range inputs
            $('input[type="range"]').on('input', function() {
                updateDisplayValue(this);
                
                // Auto-update if enabled
                if ($('#autoUpdate').is(':checked')) {
                    clearTimeout(window.updateTimer);
                    window.updateTimer = setTimeout(computeModel, 300);
                }
            });
            
            // Add event listeners to number inputs  
            $('input[type="number"]').on('change', function() {
                computeModel();
            });
            
            // Add event listeners to auto-fit checkboxes
            $('input[id^="auto_fit_"]').on('change', function() {
                const paramId = this.id.replace('auto_fit_', '');
                const slider = document.getElementById(paramId);
                const displaySpan = document.getElementById(paramId + '_val');
                
                if (slider) {
                    if (this.checked) {
                        // Enable auto-fit: disable slider and show "Auto-fit"
                        slider.disabled = true;
                        if (displaySpan) {
                            displaySpan.textContent = 'Auto-fit';
                        }
                    } else {
                        // Disable auto-fit: enable slider and show actual value
                        slider.disabled = false;
                        updateDisplayValue(slider);
                    }
                    
                    // Auto-update if enabled
                    if ($('#autoUpdate').is(':checked')) {
                        clearTimeout(window.updateTimer);
                        window.updateTimer = setTimeout(computeModel, 300);
                    }
                }
            });
            
            // Add event listeners to select dropdowns
            $('select').on('change', function() {
                // Auto-update if enabled
                if ($('#autoUpdate').is(':checked')) {
                    clearTimeout(window.updateTimer);
                    window.updateTimer = setTimeout(computeModel, 300);
                } else {
                    // For dropdowns, always trigger recompute regardless of auto-update setting
                    // since dropdown changes are typically intentional parameter changes
                    computeModel();
                }
            });
            
            // Initialize display values
            $('input[type="range"]').each(function() {
                updateDisplayValue(this);
            });
        }
        
        function updateDisplayValue(input) {
            const value = parseFloat(input.value);
            const displayId = input.id + '_val';
            let displayValue;
            
            console.log('Updating slider:', input.id, 'to value:', value);
            
            // Special handling for optional parameters - show "Auto-fit" when checkbox is checked
            if (input.id === 'anchor_horizon' || input.id === 'anchor_doubling_time' || input.id === 'doubling_decay_rate') {
                const autoFitCheckbox = document.getElementById('auto_fit_' + input.id);
                if (autoFitCheckbox && autoFitCheckbox.checked) {
                    displayValue = 'Auto-fit';
                } else {
                    displayValue = value.toFixed(3);
                }
            } else if (input.id === 'automation_fraction_at_superhuman_coder') {
                // Direct percentage display (no logit transformation)
                displayValue = (value * 100).toFixed(1) + '%';
            } else if (input.id === 'rho_progress' || input.id === 'rho_cognitive' || input.id === 'lambda' || input.id === 'swe_multiplier_at_anchor_time') {
                // Higher precision for substitutability parameters, lambda, and SWE multiplier
                displayValue = value.toFixed(2);
            } else if (input.id.includes('progress') || input.id === 'automation_slope' || input.id.includes('research_stock')) {
                displayValue = value.toFixed(1);
            } else if (input.id === 'cognitive_output_normalization') {
                // Convert log scale value to actual value
                const actualValue = Math.pow(10, value);
                displayValue = actualValue.toExponential(2);
            } else if (input.id === 'sc_time_horizon_minutes') {
                // Convert log scale value to actual value and format nicely
                const actualValue = Math.pow(10, value);
                if (actualValue >= 1000000) {
                    displayValue = (actualValue / 1000000).toFixed(1) + 'M';
                } else if (actualValue >= 1000) {
                    displayValue = (actualValue / 1000).toFixed(0) + 'k';
                } else {
                    displayValue = actualValue.toFixed(0);
                }
            } else if (input.id.includes('normalization')) {
                if (value < 0.001) {
                    displayValue = value.toExponential(2);
                } else {
                    displayValue = value.toFixed(3);
                }
            } else {
                displayValue = value.toFixed(2);
            }
            
            const displayElement = document.getElementById(displayId);
            if (displayElement) {
                displayElement.textContent = displayValue;
            } else {
                console.error('Display element not found:', displayId);
            }
        }
        
        function collectParameters() {
            // Collect and validate all parameters with proper type conversion
            const params = {};
            
            // List of expected parameters with their element IDs
            const parameterIds = [
                'rho_cognitive', 'rho_progress', 'alpha', 'software_scale',
                'automation_fraction_at_superhuman_coder', 'automation_slope', 'swe_multiplier_at_anchor_time',
                'cognitive_output_normalization', 'lambda', 'zeta', 'ai_research_taste_at_superhuman_coder',
                'ai_research_taste_slope', 'taste_schedule_type', 'sc_time_horizon_minutes',
                'horizon_extrapolation_type',
                // Manual horizon fitting parameters
                'anchor_time', 'anchor_horizon', 'anchor_doubling_time', 'doubling_decay_rate'
            ];
            
            parameterIds.forEach(id => {
                const element = $('#' + id);
                if (element.length) {
                    let value;
                    
                    // Special handling for string parameters
                    if (id === 'taste_schedule_type' || id === 'horizon_extrapolation_type') {
                        value = element.val(); // Keep as string
                    } else {
                        value = parseFloat(element.val());
                        
                        // Special handling for log scale parameters
                        if (id === 'cognitive_output_normalization') {
                            value = Math.pow(10, value);
                        } else if (id === 'sc_time_horizon_minutes') {
                            value = Math.pow(10, value);
                        }
                        
                        // Special handling for optional parameters - set to null if auto-fit checkbox is checked
                        if (id === 'anchor_horizon' || id === 'anchor_doubling_time' || id === 'doubling_decay_rate') {
                            const autoFitCheckbox = document.getElementById('auto_fit_' + id);
                            if (autoFitCheckbox && autoFitCheckbox.checked) {
                                value = null;
                            }
                        }
                    }
                    
                    // Validate numeric parameters only (allow null for optional parameters)
                    if (id !== 'taste_schedule_type' && id !== 'horizon_extrapolation_type' && value !== null && !isFinite(value)) {
                        console.warn(`Invalid value for ${id}: ${element.val()}, using fallback`);
                        // Use fallback from parameter config or hardcoded value
                        if (parameterConfig && parameterConfig.defaults && parameterConfig.defaults[id] !== undefined) {
                            value = parameterConfig.defaults[id];
                        } else {
                            // Hardcoded fallbacks as last resort
                            const fallbacks = {
                                'rho_cognitive': -2, 'rho_progress': -0.1, 'alpha': 0.5,
                                'software_scale': 0.5, 'automation_fraction_at_superhuman_coder': 0.99,
                                'automation_slope': 1.6, 'swe_multiplier_at_anchor_time': 2.0, 'cognitive_output_normalization': 1, 'zeta': 0.4,
                                'ai_research_taste_at_superhuman_coder': 0.95, 'ai_research_taste_slope': 1.2,
                                'sc_time_horizon_minutes': 50000.0,
                                'anchor_time': 2025.25, 'anchor_horizon': null, 'anchor_doubling_time': null, 'doubling_decay_rate': null
                            };
                            value = fallbacks[id] || 1;
                        }
                    }
                    
                    // For string parameters, validate against allowed values
                    if (id === 'taste_schedule_type') {
                        const allowedTypes = parameterConfig?.taste_schedule_types || ['exponential', 'sigmoid'];
                        if (!allowedTypes.includes(value)) {
                            console.warn(`Invalid taste_schedule_type: ${value}, using default`);
                            value = parameterConfig?.defaults?.taste_schedule_type || 'exponential';
                        }
                    } else if (id === 'horizon_extrapolation_type') {
                        const allowedTypes = parameterConfig?.horizon_extrapolation_types || ['exponential', 'decaying doubling time'];
                        if (!allowedTypes.includes(value)) {
                            console.warn(`Invalid horizon_extrapolation_type: ${value}, using default`);
                            value = parameterConfig?.defaults?.horizon_extrapolation_type || 'exponential';
                        }
                    }
                    
                    params[id] = value;
                } else {
                    console.warn(`Parameter element not found: ${id}`);
                }
            });
            
            console.log('Collected parameters:', params);
            return params;
        }
        
        function computeModel() {
            const parameters = collectParameters();
            
            // Validate time range inputs
            let startYear = parseInt($('#start_year').val());
            let endYear = parseInt($('#end_year').val());
            let initialProgress = parseFloat($('#initial_progress').val());
            
            // Apply fallbacks for invalid inputs
            if (!isFinite(startYear) || startYear < 2000) startYear = 2012;
            if (!isFinite(endYear) || endYear < startYear) endYear = Math.max(startYear + 1, 2035);
            if (!isFinite(initialProgress)) initialProgress = 0.0;
            
            const timeRange = [startYear, endYear];
            
            console.log('Computing model with parameters:', parameters);
            console.log('Time range:', timeRange, 'Initial progress:', initialProgress);
            showLoading(true);
            hideError();
            
            $.ajax({
                url: '/api/compute',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    parameters: parameters,
                    time_range: timeRange,
                    initial_progress: initialProgress
                }),
                success: function(response) {
                    console.log('Model response:', response);
                    if (response.success) {
                        if (response.plots && response.tabs) {
                            // Handle multi-tab response
                            createPlotTabs(response.tabs, response.plots);
                        } else if (response.plot) {
                            // Handle legacy single plot response (fallback)
                            createSinglePlot(response.plot);
                        } else {
                            showError('No plot data received from server');
                        }
                        if (response.summary) {
                            updateSummary(response.summary);
                        }
                    } else {
                        showError(response.error);
                    }
                },
                error: function(xhr) {
                    console.error('AJAX error:', xhr);
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error occurred';
                    showError(error);
                },
                complete: function() {
                    showLoading(false);
                }
            });
        }
        
        function createPlotTabs(tabs, plots, preserveActiveTab = true) {
            console.log('Creating plot tabs:', tabs, plots);
            
            // Store currently active tab before clearing
            let currentActiveTabId = null;
            if (preserveActiveTab) {
                const activeTab = $('#plotTabs .nav-link.active');
                if (activeTab.length > 0) {
                    // Extract tab ID from data-bs-target attribute
                    const target = activeTab.attr('data-bs-target');
                    if (target) {
                        currentActiveTabId = target.replace('#', '').replace('-content', '');
                        console.log('Preserving active tab:', currentActiveTabId);
                    }
                }
            }
            
            // Clean up any existing event listeners to prevent memory leaks
            $(window).off('resize.plotResize');
            $('#plotTabs button[data-bs-toggle="tab"]').off('shown.bs.tab.plotResize');
            
            // Show tab navigation
            $('#plotTabs').show();
            
            // Clear existing tabs and content
            $('#plotTabs').empty();
            $('#plotTabContent').empty();
            
            // Store plot data and tab configuration for resize handling
            window.plotData = plots;
            window.plotIds = {};
            window.tabConfigurations = tabs;
            
            // Create tab navigation and content
            let foundActiveTab = false;
            tabs.forEach((tab, index) => {
                // Determine if this tab should be active
                let isActive = false;
                if (currentActiveTabId && tab.id === currentActiveTabId) {
                    isActive = true;
                    foundActiveTab = true;
                } else if (!currentActiveTabId && index === 0) {
                    // Default to first tab if no preserved tab
                    isActive = true;
                    foundActiveTab = true;
                    currentActiveTabId = tab.id;
                }
                
                const activeClass = isActive ? 'active' : '';
                const showActiveClass = isActive ? 'show active' : '';
                
                // Create tab navigation item
                const tabNav = `
                    <li class="nav-item">
                        <button class="nav-link ${activeClass}" id="${tab.id}-tab" data-bs-toggle="tab" 
                                data-bs-target="#${tab.id}-content" type="button">
                            ${tab.name}
                        </button>
                    </li>
                `;
                $('#plotTabs').append(tabNav);
                
                // Create tab content pane
                const plotId = `plot-${tab.id}`;
                window.plotIds[tab.id] = plotId; // Store for resize handling
                
                const tabContent = `
                    <div class="tab-pane fade ${showActiveClass}" id="${tab.id}-content">
                        <div id="${plotId}" style="width: 100%; height: 100%; min-height: 600px;"></div>
                    </div>
                `;
                $('#plotTabContent').append(tabContent);
                
                // Create the plot if data exists
                if (plots[tab.id]) {
                    setTimeout(() => {
                        try {
                            // Ensure plot layout uses consistent height
                            const plotLayout = { ...plots[tab.id].layout };
                            if (plotLayout.height && plotLayout.height !== 1280) {
                                console.log(`Adjusting plot layout height from ${plotLayout.height} to match container`);
                                plotLayout.height = undefined; // Let it use container dimensions
                            }
                            
                            // Apply theme-aware backgrounds
                            const theme = document.documentElement.getAttribute('data-theme') || 'light';
                            const isDark = theme === 'dark';
                            plotLayout.paper_bgcolor = isDark ? '#0f172a' : 'white';
                            plotLayout.plot_bgcolor = isDark ? '#0f172a' : 'white';
                            plotLayout.font = { ...(plotLayout.font || {}), color: isDark ? '#e5e7eb' : '#2b2d42' };
                            plotLayout.title = { ...(plotLayout.title || {}), font: { ...(plotLayout.title?.font || {}), color: isDark ? '#e5e7eb' : '#2b2d42' } };
                            plotLayout.hoverlabel = { ...(plotLayout.hoverlabel || {}), bgcolor: isDark ? '#111827' : 'white', bordercolor: isDark ? '#334155' : '#e0e0e0', font: { ...(plotLayout.hoverlabel?.font || {}), color: isDark ? '#e5e7eb' : '#2b2d42' } };
                            Plotly.newPlot(plotId, plots[tab.id].data, plotLayout, {
                                responsive: true,
                                displayModeBar: true,
                                displaylogo: false,
                                modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                                toImageButtonOptions: {
                                    format: 'svg',
                                    filename: `ai_progress_${tab.id}`,
                                    height: null,
                                    width: null,
                                    scale: 2
                                }
                            });
                            
                            // Mark this plot as created
                            window.plotIds[tab.id + '_created'] = true;
                        } catch (error) {
                            console.error(`Failed to create plot for tab ${tab.id}:`, error);
                        }
                    }, index * 100); // Stagger plot creation to avoid overwhelming the browser
                } else {
                    console.warn(`No plot data found for tab ${tab.id}`);
                }
            });
            
            // Fallback: if preserved tab wasn't found, activate the first tab
            if (!foundActiveTab && tabs.length > 0) {
                console.log('Preserved tab not found, falling back to first tab');
                const firstTab = tabs[0];
                $(`#${firstTab.id}-tab`).addClass('active');
                $(`#${firstTab.id}-content`).addClass('show active');
                currentActiveTabId = firstTab.id;
            }
            
            // Set initial container height for the active tab immediately
            if (currentActiveTabId) {
                updatePlotContainerHeight(currentActiveTabId);
            } else if (tabs.length > 0) {
                // If no active tab ID, use the first tab for height calculation
                updatePlotContainerHeight(tabs[0].id);
            }
            
            // Add event listeners for tab changes to handle plot resizing
            setupTabResizeHandlers(tabs);
        }
        
        function updatePlotContainerHeight(tabId) {
            // Find the tab configuration for the given tabId
            const tabConfig = window.tabConfigurations?.find(tab => tab.id === tabId);
            if (tabConfig && tabConfig.rows) {
                const heightPerRow = 320; // pixels per row (reduced from 400)
                const totalHeight = heightPerRow * tabConfig.rows;
                const plotContainer = $('.plot-container')[0];
                
                console.log(`Updating plot container height for tab ${tabId}: ${tabConfig.rows} rows = ${totalHeight}px`);
                // Use !important to override CSS and ensure the change takes effect immediately
                if (plotContainer) {
                    plotContainer.style.setProperty('height', totalHeight + 'px', 'important');
                    // Also trigger a reflow to ensure the change is applied
                    plotContainer.offsetHeight;
                }
            } else {
                // Fallback: ensure reduced height is applied even without rows config
                const plotContainer = $('.plot-container');
                const currentHeight = plotContainer.height();
                if (currentHeight > 1280) {
                    console.log(`Applying reduced height fallback: ${currentHeight}px -> 1280px`);
                    const containerElement = plotContainer[0];
                    if (containerElement) {
                        containerElement.style.setProperty('height', '1280px', 'important');
                        containerElement.offsetHeight;
                    }
                }
            }
        }

        function setupTabResizeHandlers(tabs) {
            // Remove any existing event listeners to avoid duplicates
            $('#plotTabs button[data-bs-toggle="tab"]').off('shown.bs.tab.plotResize');
            
            // Add event listeners for tab shown events
            $('#plotTabs button[data-bs-toggle="tab"]').on('shown.bs.tab.plotResize', function (e) {
                const tabId = e.target.getAttribute('data-bs-target').replace('#', '').replace('-content', '');
                const plotId = window.plotIds[tabId];
                
                console.log('Tab shown:', tabId, 'Plot ID:', plotId);
                
                // Update container height for this tab
                updatePlotContainerHeight(tabId);
                
                if (plotId && window.plotIds[tabId + '_created']) {
                    setTimeout(() => {
                        try {
                            // Resize the plot to fit the container
                            Plotly.Plots.resize(plotId);
                            console.log('Resized plot for tab:', tabId);
                        } catch (error) {
                            console.warn('Failed to resize plot for tab:', tabId, error);
                            
                            // If resize fails, try to recreate the plot
                            if (window.plotData && window.plotData[tabId]) {
                                console.log('Attempting to recreate plot for tab:', tabId);
                                try {
                                    // Ensure plot layout uses consistent height during recreation
                                    const plotLayout = { ...window.plotData[tabId].layout };
                                    if (plotLayout.height && plotLayout.height !== 1280) {
                                        console.log(`Adjusting recreated plot layout height from ${plotLayout.height} to match container`);
                                        plotLayout.height = undefined; // Let it use container dimensions
                                    }
                                    
                                    const theme2 = document.documentElement.getAttribute('data-theme') || 'light';
                                    const isDark2 = theme2 === 'dark';
                                    plotLayout.paper_bgcolor = isDark2 ? '#0f172a' : 'white';
                                    plotLayout.plot_bgcolor = isDark2 ? '#0f172a' : 'white';
                                    plotLayout.font = { ...(plotLayout.font || {}), color: isDark2 ? '#e5e7eb' : '#2b2d42' };
                                    plotLayout.title = { ...(plotLayout.title || {}), font: { ...(plotLayout.title?.font || {}), color: isDark2 ? '#e5e7eb' : '#2b2d42' } };
                                    plotLayout.hoverlabel = { ...(plotLayout.hoverlabel || {}), bgcolor: isDark2 ? '#111827' : 'white', bordercolor: isDark2 ? '#334155' : '#e0e0e0', font: { ...(plotLayout.hoverlabel?.font || {}), color: isDark2 ? '#e5e7eb' : '#2b2d42' } };
                                    Plotly.newPlot(plotId, window.plotData[tabId].data, plotLayout, {
                                        responsive: true,
                                        displayModeBar: true,
                                        displaylogo: false,
                                        modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                                        toImageButtonOptions: {
                                            format: 'svg',
                                            filename: `ai_progress_${tabId}`,
                                            height: null,
                                            width: null,
                                            scale: 2
                                        }
                                    });
                                } catch (recreateError) {
                                    console.error('Failed to recreate plot for tab:', tabId, recreateError);
                                }
                            }
                        }
                    }, 50); // Small delay to ensure tab transition is complete
                }
            });
            
            // Also handle window resize events for all visible plots
            $(window).off('resize.plotResize').on('resize.plotResize', function() {
                // Find the currently active tab
                const activeTab = $('#plotTabs .nav-link.active');
                if (activeTab.length > 0) {
                    const tabId = activeTab.attr('data-bs-target').replace('#', '').replace('-content', '');
                    const plotId = window.plotIds[tabId];
                    
                    if (plotId && window.plotIds[tabId + '_created']) {
                        setTimeout(() => {
                            try {
                                Plotly.Plots.resize(plotId);
                            } catch (error) {
                                console.warn('Failed to resize plot on window resize:', plotId, error);
                            }
                        }, 100);
                    }
                }
            });
        }
        
        function createSinglePlot(plotData) {
            console.log('Creating single plot (legacy mode)');
            
            // Clean up any tab-related event listeners
            $(window).off('resize.plotResize');
            $('#plotTabs button[data-bs-toggle="tab"]').off('shown.bs.tab.plotResize');
            
            // Hide tab navigation
            $('#plotTabs').hide();
            
            // Clear existing content and create single plot container
            // Set reasonable height for single plot mode - use consistent height calculation
            const singlePlotContainer = $('.plot-container')[0];
            if (singlePlotContainer) {
                singlePlotContainer.style.setProperty('height', '1280px', 'important');
                // Force a reflow to ensure the height is applied immediately
                singlePlotContainer.offsetHeight;
            }
            $('#plotTabContent').html(`
                <div class="tab-pane fade show active" id="default-plot">
                    <div id="plotDiv" style="width: 100%; height: 100%; min-height: 1280px;"></div>
                </div>
            `);
            
            // Create the plot
            const plotDiv = document.getElementById('plotDiv');
            if (plotDiv.children.length === 0) {
                setTimeout(() => {
                    // Ensure plot layout uses consistent height
                    const plotLayout = { ...plotData.layout };
                    if (plotLayout.height && plotLayout.height !== 1280) {
                        console.log(`Adjusting single plot layout height from ${plotLayout.height} to match container`);
                        plotLayout.height = undefined; // Let it use container dimensions
                    }
                    
                    const theme = document.documentElement.getAttribute('data-theme') || 'light';
                    const isDark = theme === 'dark';
                    plotLayout.paper_bgcolor = isDark ? '#0f172a' : 'white';
                    plotLayout.plot_bgcolor = isDark ? '#0f172a' : 'white';
                    plotLayout.font = { ...(plotLayout.font || {}), color: isDark ? '#e5e7eb' : '#2b2d42' };
                    plotLayout.title = { ...(plotLayout.title || {}), font: { ...(plotLayout.title?.font || {}), color: isDark ? '#e5e7eb' : '#2b2d42' } };
                    plotLayout.hoverlabel = { ...(plotLayout.hoverlabel || {}), bgcolor: isDark ? '#111827' : 'white', bordercolor: isDark ? '#334155' : '#e0e0e0', font: { ...(plotLayout.hoverlabel?.font || {}), color: isDark ? '#e5e7eb' : '#2b2d42' } };
                    Plotly.newPlot('plotDiv', plotData.data, plotLayout, {
                        responsive: true,
                        displayModeBar: true,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                        toImageButtonOptions: {
                            format: 'png',
                            filename: 'ai_progress_model',
                            height: 1280,
                            width: null,
                            scale: 1
                        }
                    });
                }, 5);
            } else {
                // Ensure plot layout uses consistent height for updates too
                const plotLayout = { ...plotData.layout };
                if (plotLayout.height && plotLayout.height !== 1280) {
                    console.log(`Adjusting single plot update layout height from ${plotLayout.height} to match container`);
                    plotLayout.height = undefined; // Let it use container dimensions
                }
                
                const theme2 = document.documentElement.getAttribute('data-theme') || 'light';
                const isDark2 = theme2 === 'dark';
                plotLayout.paper_bgcolor = isDark2 ? '#0f172a' : 'white';
                plotLayout.plot_bgcolor = isDark2 ? '#0f172a' : 'white';
                plotLayout.font = { ...(plotLayout.font || {}), color: isDark2 ? '#e5e7eb' : '#2b2d42' };
                plotLayout.title = { ...(plotLayout.title || {}), font: { ...(plotLayout.title?.font || {}), color: isDark2 ? '#e5e7eb' : '#2b2d42' } };
                plotLayout.hoverlabel = { ...(plotLayout.hoverlabel || {}), bgcolor: isDark2 ? '#111827' : 'white', bordercolor: isDark2 ? '#334155' : '#e0e0e0', font: { ...(plotLayout.hoverlabel?.font || {}), color: isDark2 ? '#e5e7eb' : '#2b2d42' } };
                Plotly.react('plotDiv', plotData.data, plotLayout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d']
                });
            }
        }
        
        function initializeSession() {
            // Initialize server-side session data without affecting UI
            return $.ajax({
                url: '/api/default-data',
                method: 'GET',
                success: function(response) {
                    console.log('Server session initialized successfully');
                },
                error: function(xhr) {
                    console.error('Failed to initialize server session:', xhr);
                }
            });
        }
        
        function loadDefaultData() {
            // This function is kept for compatibility but now delegates to the parameter config system
            if (parameterConfig && parameterConfig.defaults) {
                console.log('Using parameter config defaults instead of /api/default-data');
                // Re-initialize controls to ensure they have the latest values
                initializeParameterControls();
                computeModel();
            } else {
                // Fallback to API call if parameter config is not available
                console.log('Parameter config not available, fetching from /api/default-data');
                $.ajax({
                    url: '/api/default-data',
                    method: 'GET',
                    success: function(response) {
                        // Update parameter controls
                        Object.keys(response.parameters).forEach(key => {
                            const element = $('#' + key);
                            if (element.length) {
                                let value = response.parameters[key];
                                
                                // Only convert cognitive output normalization to log scale for display
                                if (key === 'cognitive_output_normalization') {
                                    // Convert to log scale for display
                                    value = Math.log10(Math.max(value, 1e-5));
                                }
                                
                                element.val(value);
                                updateDisplayValue(element[0]);
                            }
                        });
                        
                        // Compute initial model
                        computeModel();
                    },
                    error: function(xhr) {
                        console.error('Failed to load default data:', xhr);
                        showError('Failed to load default parameter values');
                    }
                });
            }
        }
        
        function uploadData() {
            const fileInput = $('#csvFile')[0];
            if (!fileInput.files.length) return;
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            showLoading(true);
            
            $.ajax({
                url: '/api/upload-data',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#dataPreview').show();
                        $('#dataSummary').html(
                            `<div>Time range: ${response.data_summary.time_range[0]} - ${response.data_summary.time_range[1]}</div>` +
                            `<div>Data points: ${response.data_summary.data_points}</div>`
                        );
                        
                        // Update time range inputs
                        $('#start_year').val(Math.floor(response.data_summary.time_range[0]));
                        $('#end_year').val(Math.ceil(response.data_summary.time_range[1]));
                        
                        computeModel();
                    } else {
                        showError(response.error);
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to upload file';
                    showError(error);
                },
                complete: function() {
                    showLoading(false);
                }
            });
        }
        
        function estimateParameters() {
            const anchors = collectConstraints();
            
            if (anchors.length === 0) {
                alert('Please add at least one constraint before estimating parameters.');
                return;
            }

            const fixedParams = [];
            $('#fixedParamsCheckboxes input[type="checkbox"]').each(function() {
                if (!$(this).is(':checked')) {
                    fixedParams.push($(this).val());
                }
            });
            
            // Show validation results
            const validationDiv = document.getElementById('constraintValidation');
            const validationResults = document.getElementById('validationResults');
            validationResults.innerHTML = `
                <p><strong>Found ${anchors.length} constraint${anchors.length > 1 ? 's' : ''}:</strong></p>
                <ul>
                    ${anchors.map((anchor, i) => `
                        <li>Constraint ${i+1}: When ${Object.entries(anchor.conditions).map(([k,v]) => `${k}=${v}`).join(', ')}, 
                        expect ${anchor.target_variable} = ${anchor.target_value} (weight: ${anchor.weight})</li>
                    `).join('')}
                </ul>
            `;
            validationDiv.style.display = 'block';
            
            const initialParameters = collectParameters();
            const initialProgress = parseFloat($('#initial_progress').val());
            const timeRange = [
                parseInt($('#start_year').val()),
                parseInt($('#end_year').val())
            ];
            
            showLoading(true);
            
            $.ajax({
                url: '/api/estimate-parameters',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    anchors: anchors,
                    initial_parameters: initialParameters,
                    initial_progress: initialProgress,
                    time_range: timeRange,
                    fixed_params: fixedParams
                }),
                success: function(response) {
                    if (response.success) {
                        // Update parameter controls with estimated values
                        let updatedParams = [];
                        Object.keys(response.estimated_parameters).forEach(key => {
                            const element = $('#' + key);
                            if (element.length) {
                                const oldValue = element.val();
                                let newValue = response.estimated_parameters[key];
                                
                                // Apply bounds checking and inverse transformation for UI controls
                                newValue = applyParameterBounds(key, newValue);
                                
                                element.val(newValue);
                                updateDisplayValue(element[0]);
                                updatedParams.push(`${key}: ${parseFloat(oldValue).toFixed(4)} → ${parseFloat(newValue).toFixed(4)}`);
                                console.log(`Updated parameter ${key}: ${oldValue} → ${newValue}`);
                            } else {
                                console.warn(`UI element not found for parameter: ${key}`);
                                updatedParams.push(`${key}: ?? → ${response.estimated_parameters[key].toFixed(4)} (no UI control)`);
                            }
                        });
                        
                        // Check if we have plot data (new synchronized response)
                        if (response.plots && response.tabs && response.summary) {
                            // Handle multi-tab response
                            createPlotTabs(response.tabs, response.plots);
                        } else if (response.plot && response.summary) {
                            // Handle legacy single plot response (fallback)
                            createSinglePlot(response.plot);
                        }
                        if (response.summary) {
                            updateSummary(response.summary);
                        }
                        
                        // Show parameter changes in validation area
                        const validationResults = document.getElementById('validationResults');
                        validationResults.innerHTML += `
                            <div class="mt-3">
                                <p><strong>Parameter Updates:</strong></p>
                                <div style="font-family: monospace; font-size: 0.9em;">
                                    ${updatedParams.map(param => {
                                        const [name, change] = param.split(': ');
                                        const [oldVal, newVal] = change.split(' → ');
                                        const oldNum = parseFloat(oldVal);
                                        const newNum = parseFloat(newVal);
                                        const changePercent = oldNum !== 0 ? ((newNum - oldNum) / Math.abs(oldNum) * 100).toFixed(1) : 'N/A';
                                        const changeColor = newNum > oldNum ? 'text-success' : newNum < oldNum ? 'text-warning' : 'text-muted';
                                        return `<div>${name}: ${oldVal} → <span class="${changeColor}">${newVal}</span> <small class="text-muted">(${changePercent}%)</small></div>`;
                                    }).join('')}
                                </div>
                                
                                <div class="mt-3">
                                    <p><strong>Constraint Satisfaction Analysis:</strong></p>
                                    <div class="progress-container">
                                        ${response.constraint_evaluations.map((eval, i) => {
                                            const satisfactionPercent = (eval.satisfaction * 100).toFixed(1);
                                            const barColor = eval.satisfaction > 0.9 ? 'bg-success' : eval.satisfaction > 0.7 ? 'bg-warning' : 'bg-danger';
                                            const errorText = eval.error !== undefined ? ` (error: ${eval.error.toFixed(3)})` : '';
                                            return `
                                                <div class="mb-2">
                                                    <small>Constraint ${i+1}: ${eval.target_variable} = ${eval.target_value}${errorText}</small>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar ${barColor}" style="width: ${satisfactionPercent}%">
                                                            ${satisfactionPercent}%
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <p><strong>Optimization Results:</strong></p>
                                    <div style="font-family: monospace; font-size: 0.9em;">
                                        <div>Initial objective: ${response.optimization_info.initial_objective ? response.optimization_info.initial_objective.toFixed(6) : 'N/A'}</div>
                                        <div>Final objective: ${response.optimization_info.final_objective ? response.optimization_info.final_objective.toFixed(6) : 'N/A'}</div>
                                        <div class="text-success">Improvement: ${response.optimization_info.improvement ? response.optimization_info.improvement.toFixed(6) : 'N/A'}</div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-success mt-2">
                                    ${(response.plots || response.plot) ? '✓ Parameters estimated and model updated successfully! The graphs show the new results.' : '✓ Parameters estimated successfully! Click "Update Model" to see the results.'}
                                </div>
                                
                                ${response.computation_error ? `
                                    <div class="alert alert-warning mt-2">
                                        ⚠️ Parameter estimation succeeded, but model computation encountered an issue: ${response.computation_error}
                                        <br><small>You can try running the model manually or adjust the parameters.</small>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        
                        // Only call computeModel if we don't already have plot data
                        if (!response.plots && !response.plot) {
                            computeModel();
                        }
                    } else {
                        const validationResults = document.getElementById('validationResults');
                        validationResults.innerHTML += `
                            <div class="alert alert-danger mt-2">
                                ✗ Parameter estimation failed: ${response.error}
                            </div>
                        `;
                        showError(response.error);
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Parameter estimation failed';
                    showError(error);
                },
                complete: function() {
                    showLoading(false);
                }
            });
        }
        
        function exportResults() {
            window.location.href = '/api/export-csv';
        }
        
        function exportMETRData() {
            // Direct download - backend will handle validation
            window.location.href = '/api/export-metr-data';
        }
        

        
        function initializeParameterControls() {
            // Comprehensive initialization of all parameter controls from config
            if (!parameterConfig) {
                console.warn('Parameter config not available, using fallback initialization');
                initializeFallbackControls();
                return;
            }
            
            // Initialize range sliders
            if (parameterConfig.bounds && parameterConfig.defaults) {
                Object.entries(parameterConfig.bounds).forEach(([paramName, bounds]) => {
                    const slider = document.getElementById(paramName);
                    const defaultValue = parameterConfig.defaults[paramName];
                    
                    if (slider && slider.type === 'range') {
                        const [min, max] = bounds;
                        
                        // Special handling for certain parameters
                        if (paramName === 'cognitive_output_normalization') {
                            // This slider uses log scale, so convert bounds and default
                            slider.min = Math.log10(Math.max(min, 1e-5)); // Avoid log(0)
                            slider.max = Math.log10(max);
                            slider.value = Math.log10(Math.max(defaultValue, 1e-5));
                        } else if (paramName === 'sc_time_horizon_minutes') {
                            // This slider uses log scale for better usability with large range
                            slider.min = Math.log10(Math.max(min, 1));
                            slider.max = Math.log10(max);
                            slider.value = Math.log10(Math.max(defaultValue, 1));
                        } else {
                            slider.min = min;
                            slider.max = max;
                            slider.value = defaultValue;
                        }
                        
                        // Update display value
                        updateDisplayValue(slider);
                        
                        // Update range display text if element exists
                        const rangeDisplay = document.getElementById(paramName + '_range');
                        if (rangeDisplay) {
                            rangeDisplay.textContent = `Range: [${min}, ${max}]`;
                        }
                        
                        console.log(`Initialized ${paramName}: bounds=[${slider.min}, ${slider.max}], value=${slider.value}`);
                    }
                });
            }
            
            // Initialize dropdown controls
            if (parameterConfig.taste_schedule_types && parameterConfig.defaults) {
                const tasteScheduleSelect = document.getElementById('taste_schedule_type');
                if (tasteScheduleSelect) {
                    // Clear existing options
                    tasteScheduleSelect.innerHTML = '';
                    
                    // Add options from config
                    parameterConfig.taste_schedule_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                        tasteScheduleSelect.appendChild(option);
                    });
                    
                    // Set default value
                    const defaultType = parameterConfig.defaults.taste_schedule_type || 'exponential';
                    tasteScheduleSelect.value = defaultType;
                    
                    console.log(`Initialized taste_schedule_type dropdown with options: ${parameterConfig.taste_schedule_types.join(', ')}, default: ${defaultType}`);
                }
            }
            
            if (parameterConfig.horizon_extrapolation_types && parameterConfig.defaults) {
                const horizonExtrapolationSelect = document.getElementById('horizon_extrapolation_type');
                if (horizonExtrapolationSelect) {
                    // Clear existing options
                    horizonExtrapolationSelect.innerHTML = '';
                    
                    // Add options from config
                    parameterConfig.horizon_extrapolation_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                        horizonExtrapolationSelect.appendChild(option);
                    });
                    
                    // Set default value
                    const defaultType = parameterConfig.defaults.horizon_extrapolation_type || 'exponential';
                    horizonExtrapolationSelect.value = defaultType;
                    
                    console.log(`Initialized horizon_extrapolation_type dropdown with options: ${parameterConfig.horizon_extrapolation_types.join(', ')}, default: ${defaultType}`);
                }
            }
            
            // Initialize number inputs (simulation settings)
            // Use hardcoded defaults since simulation settings aren't in parameter config yet
            const startYear = document.getElementById('start_year');
            if (startYear) {
                startYear.value = startYear.value || 2012;
                startYear.min = 2000;
                startYear.max = 2050;
            }
            
            const endYear = document.getElementById('end_year');
            if (endYear) {
                endYear.value = endYear.value || 2035;
                endYear.min = 2020;
                endYear.max = 2100;
            }
            
            const initialProgress = document.getElementById('initial_progress');
            if (initialProgress) {
                initialProgress.value = initialProgress.value || 0.0;
                initialProgress.min = -100;
                initialProgress.max = 100;
            }
            
            // Initialize auto-fit checkboxes and their corresponding sliders
            const autoFitParams = ['anchor_horizon', 'anchor_doubling_time', 'doubling_decay_rate'];
            autoFitParams.forEach(paramId => {
                const checkbox = document.getElementById('auto_fit_' + paramId);
                const slider = document.getElementById(paramId);
                
                if (checkbox && slider) {
                    // Set initial state based on checkbox
                    if (checkbox.checked) {
                        slider.disabled = true;
                        const displaySpan = document.getElementById(paramId + '_val');
                        if (displaySpan) {
                            displaySpan.textContent = 'Auto-fit';
                        }
                    } else {
                        slider.disabled = false;
                        updateDisplayValue(slider);
                    }
                }
            });
            
            // Update parameter labels from descriptions if available
            if (parameterConfig.descriptions) {
                Object.entries(parameterConfig.descriptions).forEach(([paramName, info]) => {
                    const label = document.querySelector(`label[for="${paramName}"], label:has(#${paramName})`);
                    if (label && info.name) {
                        // Update the label text while preserving the span for display value
                        const span = label.querySelector('span');
                        const spanHtml = span ? span.outerHTML : '';
                        const colonIndex = label.innerHTML.indexOf(':');
                        if (colonIndex !== -1) {
                            label.innerHTML = `${info.name}: ${spanHtml}`;
                        }
                    }
                });
            }
        }
        
        function applyParameterBounds(key, value) {
            // Centralized bounds checking and transformation for UI controls
            let newValue = value;
            
            // Special handling for cognitive_output_normalization (log scale conversion)
            if (key === 'cognitive_output_normalization') {
                // Convert from actual value to log scale for the slider
                newValue = Math.log10(Math.max(value, 1e-5)); // Avoid log(0)
            }
            
            // Get bounds from parameter config if available, otherwise use element attributes or fallbacks
            let minVal, maxVal;
            if (parameterConfig && parameterConfig.bounds && parameterConfig.bounds[key]) {
                const bounds = parameterConfig.bounds[key];
                minVal = bounds[0];
                maxVal = bounds[1];
                
                // Apply log scale conversion to bounds for cognitive_output_normalization
                if (key === 'cognitive_output_normalization') {
                    minVal = Math.log10(Math.max(bounds[0], 1e-5));
                    maxVal = Math.log10(bounds[1]);
                }
            } else {
                // Fall back to element attributes or hardcoded bounds
                const element = $('#' + key);
                if (element.length) {
                    minVal = parseFloat(element.attr('min'));
                    maxVal = parseFloat(element.attr('max'));
                }
                
                // If still no bounds, use hardcoded fallbacks as last resort
                if (isNaN(minVal) || isNaN(maxVal)) {
                    const fallbackBounds = {
                        'rho_cognitive': [-10, 1],
                        'rho_progress': [-1, 1],
                        'alpha': [0.05, 0.95],
                        'software_scale': [0.1, 10],
                        'automation_fraction_at_superhuman_coder': [0.1, 0.99],
                        'automation_slope': [0.1, 10],
                        'swe_multiplier_at_anchor_time': [1.0, 10.0],
                        'cognitive_output_normalization': [-5, 1],
                        'zeta': [0.1, 1.0],
                        'ai_research_taste_at_superhuman_coder': [0.1, 5],
                        'ai_research_taste_slope': [0.1, 10],
                        'sc_time_horizon_minutes': [3, 6]  // Log scale bounds
                    };
                    
                    if (fallbackBounds[key]) {
                        [minVal, maxVal] = fallbackBounds[key];
                    }
                }
            }
            
            // Apply bounds if we have them
            if (!isNaN(minVal) && !isNaN(maxVal)) {
                newValue = Math.max(minVal, Math.min(maxVal, newValue));
            }
            
            return newValue;
        }
        
        function initializeFallbackControls() {
            // Fallback initialization with hardcoded values when config is not available
            const fallbackData = {
                'rho_cognitive': { min: -10, max: 1, value: -2, range: '[-10, 0]' },
                'rho_progress': { min: -1, max: 1, value: -0.2, range: '[-1, 1]' },
                'alpha': { min: 0.05, max: 0.95, value: 0.5 },
                'software_scale': { min: 0.1, max: 10, value: 1.0, range: '[0.1, 10]' },
                'automation_fraction_at_superhuman_coder': { min: 0.1, max: 0.99, value: 0.99 },
                'automation_slope': { min: 0.1, max: 10, value: 2.0 },
                'swe_multiplier_at_anchor_time': { min: 1.0, max: 10.0, value: 2.0 },
                'cognitive_output_normalization': { min: -5, max: 1, value: 0 },
                'zeta': { min: 0.1, max: 1.0, value: 0.4, range: '[0.1, 1.0]' },
                'ai_research_taste_at_superhuman_coder': { min: 0.1, max: 5, value: 0.95 },
                'ai_research_taste_slope': { min: 0.1, max: 10, value: 1.2 },
                'sc_time_horizon_minutes': { min: 3, max: 6, value: 4.7 },  // Log scale: 10^3 to 10^6, default 10^4.7 ≈ 50000
                // Manual horizon fitting parameters
                'anchor_time': { min: 2020.0, max: 2030.0, value: 2025.25 },
                'anchor_horizon': { min: 0.01, max: 10000.0, value: 1000.0 },  // Default to reasonable value
                'anchor_doubling_time': { min: 0.01, max: 100.0, value: 2.0 },  // Default to reasonable value
                'doubling_decay_rate': { min: 0.001, max: 1.0, value: 0.1 }  // Default to reasonable value
            };
            
            Object.entries(fallbackData).forEach(([paramName, config]) => {
                const slider = document.getElementById(paramName);
                if (slider && slider.type === 'range') {
                    slider.min = config.min;
                    slider.max = config.max;
                    slider.value = config.value;
                    updateDisplayValue(slider);
                    
                    // Update range display if available
                    const rangeDisplay = document.getElementById(paramName + '_range');
                    if (rangeDisplay && config.range) {
                        rangeDisplay.textContent = `Range: ${config.range}`;
                    } else if (paramName === 'sc_time_horizon_minutes') {
                        // Special display for log scale parameter
                        if (rangeDisplay) {
                            rangeDisplay.textContent = 'Range: [1k, 1M minutes]';
                        }
                    }
                }
            });
            
            // Fallback simulation settings
            const simSettings = {
                'start_year': { value: 2012, min: 2000, max: 2050 },
                'end_year': { value: 2035, min: 2020, max: 2100 },
                'initial_progress': { value: 0.0, min: 0.0, max: 100 }
            };
            
            Object.entries(simSettings).forEach(([inputName, config]) => {
                const input = document.getElementById(inputName);
                if (input) {
                    input.value = config.value;
                    input.min = config.min;
                    input.max = config.max;
                }
            });
            
            // Initialize auto-fit checkboxes and their corresponding sliders
            const autoFitParams = ['anchor_horizon', 'anchor_doubling_time', 'doubling_decay_rate'];
            autoFitParams.forEach(paramId => {
                const checkbox = document.getElementById('auto_fit_' + paramId);
                const slider = document.getElementById(paramId);
                
                if (checkbox && slider) {
                    // Set initial state based on checkbox (defaults to checked/auto-fit)
                    if (checkbox.checked) {
                        slider.disabled = true;
                        const displaySpan = document.getElementById(paramId + '_val');
                        if (displaySpan) {
                            displaySpan.textContent = 'Auto-fit';
                        }
                    } else {
                        slider.disabled = false;
                        updateDisplayValue(slider);
                    }
                }
            });
        }
        
        function populateFixedParamsCheckboxes() {
            const container = $('#fixedParamsCheckboxes');
            container.empty();

            // Use parameter config from server if available, otherwise fallback to hardcoded
            let params;
            if (parameterConfig && parameterConfig.descriptions) {
                params = {};
                Object.entries(parameterConfig.descriptions).forEach(([id, info]) => {
                    params[id] = info.name || info.display_name || id;
                });
            } else {
                // Fallback to hardcoded values (reduced reliance on hardcoded data)
                console.warn('Using fallback parameter names for checkboxes');
                params = {
                    'rho_cognitive': 'Cognitive Elasticity',
                    'rho_progress': 'Progress Elasticity',
                    'alpha': 'Compute Weight',
                    'software_scale': 'Software Scale',
                    'automation_fraction_at_superhuman_coder': 'SC Automation Fraction:',
                    'automation_slope': 'Automation Slope',
                    'swe_multiplier_at_anchor_time': 'SWE Multiplier at Anchor Time',
                    'cognitive_output_normalization': 'Parallel Coding Labor Normalization',
                    'zeta': 'Experiment Compute Discounting',
                    'ai_research_taste_at_superhuman_coder': 'SC Research Taste',
                    'ai_research_taste_slope': 'AI Research Taste Slope',
                    'sc_time_horizon_minutes': 'Time Horizon to Superhuman Coder'
                };
            }

            Object.entries(params).forEach(([id, label]) => {
                const checkboxHtml = `
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" value="${id}" id="fix_param_${id}" checked>
                        <label class="form-check-label" for="fix_param_${id}">
                            ${label}
                        </label>
                    </div>
                `;
                container.append(checkboxHtml);
            });
        }
        
        function showLoading(show) {
            if (show) {
                $('#loadingSpinner').show();
                $('#plotDiv').hide();
            } else {
                $('#loadingSpinner').hide();
                $('#plotDiv').show();
            }
        }
        
        function showError(message) {
            $('#errorMessage').text(message);
            $('#errorAlert').show();
        }
        
        function hideError() {
            $('#errorAlert').hide();
        }
        function updateSummary(summary) {
            try {
                $('#summaryCards').show();
                const fmt = (n, digits=2) => {
                    if (n === null || n === undefined || !isFinite(n)) return '—';
                    return Number(n).toFixed(digits).replace(/\.0+$/,'').replace(/\.([1-9])0+$/,'.$1');
                };
                // SC Time (years)
                $('#summary_sc_time').text(summary.sc_time != null ? fmt(summary.sc_time, 3) : '—');
                // SC R&D progress multiplier
                $('#summary_sc_rd_multiplier').text(summary.sc_sw_multiplier != null ? fmt(summary.sc_sw_multiplier, 2) + 'x' : '—');
            } catch (e) {
                console.warn('Failed to update summary', e);
            }
        }
        
        function resetToDefaults() {
            // Reset to defaults using the most appropriate method
            if (parameterConfig && parameterConfig.defaults) {
                console.log('Resetting to parameter config defaults');
                initializeParameterControls();
                computeModel();
            } else {
                console.log('Resetting using /api/default-data');
                loadDefaultData();
            }
        }
        
        let constraintCounter = 0;
        
        function addAnchorConstraint() {
            constraintCounter++;
            const constraintId = `constraint_${constraintCounter}`;
            
            const constraintHtml = `
                <div class="card mb-3" id="${constraintId}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Constraint ${constraintCounter}</h6>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeConstraint('${constraintId}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Condition</h6>
                                <div class="mb-2">
                                    <label class="form-label">Condition Variable</label>
                                    <select class="form-select form-select-sm" name="condition_variable">
                                        <option value="time">Time</option>
                                        <option value="automation_fraction">Automation Fraction</option>
                                        <option value="L_AI">AI Labor</option>
                                        <option value="L_HUMAN">Human Labor</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Condition Value</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           name="condition_value" placeholder="Enter value" step="any" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Target</h6>
                                <div class="mb-2">
                                    <label class="form-label">Target Variable</label>
                                    <select class="form-select form-select-sm" name="target_variable">
                                        <option value="progress_rate">Progress Rate</option>
                                        <option value="automation_fraction">Automation Fraction</option>
                                        <option value="cognitive_output">Parallel Coding Labor</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Target Value</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           name="target_value" placeholder="Expected value" step="any" required>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Weight</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           name="weight" value="1.0" step="0.1" min="0.1">
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                Preview: When <span class="condition-var-preview" data-constraint="${constraintId}">condition variable</span> = 
                                <span class="condition-val-preview" data-constraint="${constraintId}">value</span>, 
                                expect <span class="target-preview" data-constraint="${constraintId}">target variable</span> = 
                                <span class="value-preview" data-constraint="${constraintId}">value</span>
                            </small>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('anchorConstraints').insertAdjacentHTML('beforeend', constraintHtml);
            updateConstraintPreview(constraintId);
            updateEstimateButton();
            
            // Add event listeners for preview updates
            const constraintCard = document.getElementById(constraintId);
            constraintCard.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', () => updateConstraintPreview(constraintId));
            });
        }
        
        function removeConstraint(constraintId) {
            document.getElementById(constraintId).remove();
            updateEstimateButton();
        }
        
        function updateConstraintPreview(constraintId) {
            const card = document.getElementById(constraintId);
            const inputs = card.querySelectorAll('input, select');
            
            let conditionVar = '';
            let conditionVal = '';
            let targetVar = '';
            let targetVal = '';
            
            inputs.forEach(input => {
                const value = input.value;
                if (input.name === 'condition_variable') {
                    conditionVar = value;
                } else if (input.name === 'condition_value') {
                    conditionVal = value;
                } else if (input.name === 'target_variable') {
                    targetVar = value;
                } else if (input.name === 'target_value') {
                    targetVal = value;
                }
            });
            
            card.querySelector('.condition-var-preview').textContent = conditionVar || 'condition variable';
            card.querySelector('.condition-val-preview').textContent = conditionVal || 'value';
            card.querySelector('.target-preview').textContent = targetVar || 'target variable';
            card.querySelector('.value-preview').textContent = targetVal || 'value';
        }
        
        function updateEstimateButton() {
            const constraintCount = document.querySelectorAll('#anchorConstraints .card').length;
            const estimateBtn = document.getElementById('estimateBtn');
            
            if (constraintCount > 0) {
                estimateBtn.disabled = false;
                estimateBtn.textContent = `Estimate Parameters (${constraintCount} constraint${constraintCount > 1 ? 's' : ''})`;
            } else {
                estimateBtn.disabled = true;
                estimateBtn.textContent = 'Estimate Parameters (Add constraints first)';
            }
        }
        
        function collectConstraints() {
            const constraints = [];
            const constraintCards = document.querySelectorAll('#anchorConstraints .card');
            
            constraintCards.forEach(card => {
                const inputs = card.querySelectorAll('input, select');
                const constraint = {
                    conditions: {},
                    target_variable: '',
                    target_value: 0,
                    weight: 1.0
                };
                
                let conditionVariable = '';
                let conditionValue = '';
                
                inputs.forEach(input => {
                    const value = input.value;
                    if (value) {
                        if (input.name === 'condition_variable') {
                            conditionVariable = value;
                        } else if (input.name === 'condition_value') {
                            conditionValue = parseFloat(value);
                        } else if (input.name === 'target_variable') {
                            constraint.target_variable = value;
                        } else if (input.name === 'target_value') {
                            constraint.target_value = parseFloat(value);
                        } else if (input.name === 'weight') {
                            constraint.weight = parseFloat(value);
                        }
                    }
                });
                
                // Add the single condition to the conditions object
                if (conditionVariable && conditionValue !== '') {
                    constraint.conditions[conditionVariable] = conditionValue;
                }
                
                if (constraint.target_variable && constraint.target_value !== '' && Object.keys(constraint.conditions).length > 0) {
                    constraints.push(constraint);
                }
            });
            
            return constraints;
        }
    </script>
</body>
</html>